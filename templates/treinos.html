{% extends "base.html" %}

{% block title %}Treinos - GymFlow{% endblock %}

{% block extra_css %}
<style>
    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .card-header {
        background-color: transparent;
        border-bottom: none;
        padding: 20px;
    }
    
    .card-body {
        padding: 20px;
    }
    
    .treino-item {
        border-left: 4px solid #0d6efd;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #f8f9fa;
        border-radius: 0 5px 5px 0;
    }
    
    .treino-item:hover {
        background-color: #e9ecef;
    }
    
    .exercicio-item {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .exercicio-item:last-child {
        border-bottom: none;
    }
    
    .btn-acao {
        padding: 5px 10px;
        font-size: 0.875rem;
    }
    
    .filtro-container {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Gerenciamento de Treinos</h1>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovoTreino">
            <i class="bi bi-plus-lg"></i> Novo Treino
        </button>
    </div>
    
    <!-- Filtros -->
    <div class="filtro-container">
        <div class="row">
            <div class="col-md-3">
                <label for="filtroAluno" class="form-label">Aluno</label>
                <input type="text" class="form-control" id="filtroAluno" 
                       placeholder="Nome do aluno">
            </div>
            <div class="col-md-3">
                <label for="filtroTipo" class="form-label">Tipo de Treino</label>
                <select class="form-select" id="filtroTipo">
                    <option value="">Todos</option>
                    <option value="musculacao">Musculação</option>
                    <option value="cardio">Cardio</option>
                    <option value="funcional">Funcional</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="filtroProfessor" class="form-label">Professor</label>
                <select class="form-select" id="filtroProfessor">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="filtroStatus" class="form-label">Status</label>
                <select class="form-select" id="filtroStatus">
                    <option value="">Todos</option>
                    <option value="ativo">Ativo</option>
                    <option value="inativo">Inativo</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- Lista de Treinos -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div id="listaTreinos">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Novo Treino -->
<div class="modal fade" id="modalNovoTreino" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Treino</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNovoTreino">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="alunoTreino" class="form-label">Aluno</label>
                            <select class="form-select" id="alunoTreino" required>
                                <option value="">Selecione um aluno</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="tipoTreino" class="form-label">Tipo de Treino</label>
                            <select class="form-select" id="tipoTreino" required>
                                <option value="musculacao">Musculação</option>
                                <option value="cardio">Cardio</option>
                                <option value="funcional">Funcional</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="exercicios">
                        <h6 class="mb-3">Exercícios</h6>
                        <div class="exercicio-container">
                            <!-- Exercícios serão adicionados aqui -->
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" 
                                id="btnAdicionarExercicio">
                            <i class="bi bi-plus-lg"></i> Adicionar Exercício
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnSalvarTreino">
                    Salvar Treino
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Template do Exercício -->
<template id="templateExercicio">
    <div class="exercicio-item">
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">Exercício</label>
                <input type="text" class="form-control exercicio-nome" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">Séries</label>
                <input type="number" class="form-control exercicio-series" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">Repetições</label>
                <input type="number" class="form-control exercicio-repeticoes" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Carga (kg)</label>
                <input type="number" class="form-control exercicio-carga" step="0.5">
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-danger btn-sm btn-remover-exercicio">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modalNovoTreino = new bootstrap.Modal(
            document.getElementById('modalNovoTreino')
        );
        const formNovoTreino = document.getElementById('formNovoTreino');
        const btnAdicionarExercicio = document.getElementById('btnAdicionarExercicio');
        const exerciciosContainer = document.querySelector('.exercicio-container');
        const templateExercicio = document.getElementById('templateExercicio');
        
        // Carregar lista de alunos
        async function carregarAlunos() {
            try {
                const response = await fetch('/alunos');
                const alunos = await response.json();
                
                const selectAluno = document.getElementById('alunoTreino');
                alunos.forEach(aluno => {
                    const option = document.createElement('option');
                    option.value = aluno.id;
                    option.textContent = aluno.nome;
                    selectAluno.appendChild(option);
                });
            } catch (erro) {
                console.error('Erro ao carregar alunos:', erro);
            }
        }
        
        // Carregar lista de professores
        async function carregarProfessores() {
            try {
                const response = await fetch('/professores');
                const professores = await response.json();
                
                const selectProfessor = document.getElementById('filtroProfessor');
                professores.forEach(professor => {
                    const option = document.createElement('option');
                    option.value = professor.id;
                    option.textContent = professor.nome;
                    selectProfessor.appendChild(option);
                });
            } catch (erro) {
                console.error('Erro ao carregar professores:', erro);
            }
        }
        
        // Adicionar novo exercício
        function adicionarExercicio() {
            const clone = document.importNode(templateExercicio.content, true);
            
            // Configurar botão de remover
            const btnRemover = clone.querySelector('.btn-remover-exercicio');
            btnRemover.addEventListener('click', function(e) {
                e.target.closest('.exercicio-item').remove();
            });
            
            exerciciosContainer.appendChild(clone);
        }
        
        // Salvar novo treino
        async function salvarTreino() {
            const exercicios = [];
            document.querySelectorAll('.exercicio-item').forEach(item => {
                exercicios.push({
                    nome: item.querySelector('.exercicio-nome').value,
                    series: parseInt(item.querySelector('.exercicio-series').value),
                    repeticoes: parseInt(item.querySelector('.exercicio-repeticoes').value),
                    carga: parseFloat(item.querySelector('.exercicio-carga').value || 0)
                });
            });
            
            const dados = {
                aluno_id: document.getElementById('alunoTreino').value,
                tipo: document.getElementById('tipoTreino').value,
                exercicios: exercicios,
                observacoes: document.getElementById('observacoes').value
            };
            
            try {
                const response = await fetch('/treinos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });
                
                if (response.ok) {
                    alert('Treino salvo com sucesso!');
                    modalNovoTreino.hide();
                    carregarTreinos();
                } else {
                    const erro = await response.json();
                    alert(erro.erro || 'Erro ao salvar treino');
                }
            } catch (erro) {
                console.error('Erro ao salvar treino:', erro);
                alert('Erro ao salvar treino');
            }
        }
        
        // Carregar treinos
        async function carregarTreinos() {
            try {
                const filtros = {
                    aluno: document.getElementById('filtroAluno').value,
                    tipo: document.getElementById('filtroTipo').value,
                    professor: document.getElementById('filtroProfessor').value,
                    status: document.getElementById('filtroStatus').value
                };
                
                const queryString = new URLSearchParams(filtros).toString();
                const response = await fetch(`/treinos?${queryString}`);
                const treinos = await response.json();
                
                const listaTreinos = document.getElementById('listaTreinos');
                listaTreinos.innerHTML = '';
                
                treinos.forEach(treino => {
                    const div = document.createElement('div');
                    div.className = 'treino-item';
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="mb-1">${treino.aluno.nome}</h5>
                                <p class="mb-1">
                                    <span class="badge bg-primary">${treino.tipo}</span>
                                    <small class="text-muted ms-2">
                                        Criado em: ${new Date(treino.data_criacao).toLocaleDateString()}
                                    </small>
                                </p>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary btn-acao me-2"
                                        onclick="editarTreino(${treino.id})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-acao"
                                        onclick="excluirTreino(${treino.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Exercícios:</h6>
                            <ul class="list-unstyled">
                                ${treino.exercicios.map(ex => `
                                    <li>
                                        ${ex.nome} - ${ex.series}x${ex.repeticoes} 
                                        ${ex.carga ? `(${ex.carga}kg)` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        ${treino.observacoes ? `
                            <div class="mt-2">
                                <small class="text-muted">
                                    <strong>Observações:</strong> ${treino.observacoes}
                                </small>
                            </div>
                        ` : ''}
                    `;
                    listaTreinos.appendChild(div);
                });
            } catch (erro) {
                console.error('Erro ao carregar treinos:', erro);
            }
        }
        
        // Event Listeners
        btnAdicionarExercicio.addEventListener('click', adicionarExercicio);
        
        document.getElementById('btnSalvarTreino').addEventListener('click', salvarTreino);
        
        // Filtros
        ['filtroAluno', 'filtroTipo', 'filtroProfessor', 'filtroStatus'].forEach(id => {
            document.getElementById(id).addEventListener('change', carregarTreinos);
        });
        
        document.getElementById('filtroAluno').addEventListener('input', 
            debounce(carregarTreinos, 300)
        );
        
        // Inicialização
        carregarAlunos();
        carregarProfessores();
        carregarTreinos();
        adicionarExercicio(); // Adiciona um exercício inicial
    });
    
    // Função de debounce para evitar muitas requisições
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Funções globais para edição e exclusão
    async function editarTreino(id) {
        // Implementar edição de treino
        console.log('Editar treino:', id);
    }
    
    async function excluirTreino(id) {
        if (confirm('Tem certeza que deseja excluir este treino?')) {
            try {
                const response = await fetch(`/treinos/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Treino excluído com sucesso!');
                    carregarTreinos();
                } else {
                    const erro = await response.json();
                    alert(erro.erro || 'Erro ao excluir treino');
                }
            } catch (erro) {
                console.error('Erro ao excluir treino:', erro);
                alert('Erro ao excluir treino');
            }
        }
    }
</script>
{% endblock %} 